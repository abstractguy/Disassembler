// instruction_management.c
#include "instruction_management.h"

instruction_type instruction_types[256] = {
  ONE_BYTE_INSTRUCTION,
  ADDR_11,
  ADDR_16,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  DIRECT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  BIT_OFFSET,
  ADDR_11,
  ADDR_16,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  DIRECT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  BIT_OFFSET,
  ADDR_11,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  IMMEDIATE,
  DIRECT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  BIT_OFFSET,
  ADDR_11,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  IMMEDIATE,
  DIRECT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  OFFSET,
  ADDR_11,
  DIRECT,
  DIRECT_IMMEDIATE,
  IMMEDIATE,
  DIRECT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  OFFSET,
  ADDR_11,
  DIRECT,
  DIRECT_IMMEDIATE,
  IMMEDIATE,
  DIRECT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  OFFSET,
  ADDR_11,
  DIRECT,
  DIRECT_IMMEDIATE,
  IMMEDIATE,
  DIRECT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  OFFSET,
  ADDR_11,
  BIT,
  ONE_BYTE_INSTRUCTION,
  IMMEDIATE,
  DIRECT_IMMEDIATE,
  IMMEDIATE,
  IMMEDIATE,
  IMMEDIATE,
  IMMEDIATE,
  IMMEDIATE,
  IMMEDIATE,
  IMMEDIATE,
  IMMEDIATE,
  IMMEDIATE,
  IMMEDIATE,
  OFFSET,
  ADDR_11,
  BIT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  DIRECT_DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  IMMEDIATE_16,
  ADDR_11,
  BIT,
  ONE_BYTE_INSTRUCTION,
  IMMEDIATE,
  DIRECT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  NOT_BIT,
  ADDR_11,
  BIT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  DIRECT,
  NOT_BIT,
  ADDR_11,
  BIT,
  ONE_BYTE_INSTRUCTION,
  IMMEDIATE_OFFSET,
  DIRECT_OFFSET,
  IMMEDIATE_OFFSET,
  IMMEDIATE_OFFSET,
  IMMEDIATE_OFFSET,
  IMMEDIATE_OFFSET,
  IMMEDIATE_OFFSET,
  IMMEDIATE_OFFSET,
  IMMEDIATE_OFFSET,
  IMMEDIATE_OFFSET,
  IMMEDIATE_OFFSET,
  IMMEDIATE_OFFSET,
  DIRECT,
  ADDR_11,
  BIT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  DIRECT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  DIRECT,
  ADDR_11,
  BIT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  DIRECT_OFFSET,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  OFFSET,
  OFFSET,
  OFFSET,
  OFFSET,
  OFFSET,
  OFFSET,
  OFFSET,
  OFFSET,
  ONE_BYTE_INSTRUCTION,
  ADDR_11,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  DIRECT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ADDR_11,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  DIRECT,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION,
  ONE_BYTE_INSTRUCTION
};

unsigned char instruction_size(unsigned char bytecode) {
  instruction_type type = instruction_types[bytecode];
  switch (type) {
    case ONE_BYTE_INSTRUCTION: return 1;
    case ADDR_11:
    case DIRECT:
    case IMMEDIATE:
    case OFFSET:
    case BIT:
    case NOT_BIT: return 2;
    case ADDR_16:
    case IMMEDIATE_16:
    case BIT_OFFSET:
    case DIRECT_IMMEDIATE:
    case DIRECT_DIRECT:
    case IMMEDIATE_OFFSET:
    case DIRECT_OFFSET: return 3;
    default: return 0;
  }
}

record *extract_instructions(char *file) {
  record *forward  = hex_file_to_records(file);
  record *backward = NULL, *next = NULL;
  unsigned char size;

  while (forward) {
    size = instruction_size(forward->bytecode[0]);
    if (forward->size != size && forward->mode != END) {

      next = copy_record_from_offset(forward, forward->size - size, size, forward->next);

      backward = copy_record_from_offset(forward, size, 0, backward);

      forward = destroy_record(forward);
    } else {
      next            = forward->next;
      forward->next   = backward;
      backward        = forward;
    }

    forward = next;
  }

  return reverse_records(backward);
}
